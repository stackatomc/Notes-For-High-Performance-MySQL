# 第3章 服务器性能剖析

标签：MySQL


---

## 最常见的三个性能相关的服务请求:

- 三个性能相关问题
	- 如何确认服务器是否达到了性能最佳的状态
	- 某条语句为什么执行不够快
	- 诊断被用户描述成“停顿”、“堆积”或者“卡死”的某些间接性疑难故障
- 解决思路
	- 专注测量服务器的时间花费在哪里
	- 使用技术是性能剖析

---

### 性能优化

### 性能优化概念
- 通过任务和时间而不是资源来测量性能，资源是用来消耗的
- 目标可设为降低响应时间，测量和分析都非常重要
- 一项任务完成的时间分为2两部
	- 执行时间。解决方法是定位不同子任务花费的时间优化任务、降低该子任务执行频率和提高子任务执行效率
	- 等待时间。可能由于征用资源或CPT相互影响

### 性能剖析与优化

- 两个步骤
	- 测量任务所花费的时间
	- 对结果进行统计和排序，将重要的任务排在前面。多数工具会对任务分组并进行汇总
- 工具实例mk-query-digest
	- 可得出查询的响应时间和占总时间的百分比、查询的执行次数、单次执行的平均响应时间、以及该查询的摘要。p70
	- 可分析得出该示例中大多数时间花费在SELECT查询上，若继续深入分析，可能发现时间都花费在等待I/O完成上
- 性能剖析判断优化的一些理解
	- 根据Amdahl定律，一些只占总响应时间比重很小的查询是不值得优化的
	- 当某优化成本大于收益，应当停止优化
	- 某些不常出现无法在工具查询结果中体现出的，也应留意，判断是否执行频率低却大大影响用户体验等，根据优化开销与收益判断
	- 有些看似细节的时间之差，看似不属于查询对象所花费时间，但仍需要引起重视，可能暗藏重要的信息
	- 被隐藏的细节。通常，平均值无法看到很多重要信息，需要多方面对数据剖析，计算百分比、标准差、偏差指数等
	- 推荐New Relic软件支持从web浏览器到应用代码、数据库和外部调用的剖析，可全天候测量生产环境的代码

### 应用性能可能存在的性能瓶颈

- 大量对外部资源的调用
- 应用需要处理大量的数据，如分析一个超大的XML文件
- 在循环中执行昂贵的操作，如滥用正则表达式
- 使用了低效的算法。如暴力搜索算法

### 性能剖析是否导致服务器变慢

- 性能剖析产生开销，但同时可以帮助应用运行的更快。因此需要综合判断获得的收益是否能够低效这些开销
- 并建议在所有的新项目中都考虑包含性能剖析的代码，在已有项目中加入也许很困难，新项目容易一些
- 减退对应用构建一些可以永久使用的轻量级的性能剖析

> 测量PHP应用程序P74 (待学)

---

## 剖析MySQL查询

- 两种方式
	- 分析整个数据库服务器，分析出哪些查询是主要的压力来源
	- 定位到具体需要优化的查询后，通过钻取下去对其进行单独的剖析
- 推荐慢查询，只捕获比较慢的查询，且是开销最低、精度最高的测量查询工具，不带来过多I/O开销，可忽略。更需要注意写入日志消耗的大量磁盘空间，因此建议需要采集负载样本期间才开启
- 第二种是通过抓取TCP网络包，可解析更高级的协议特性，如解析二进制协议
- 第三种少用，通过Proxyy代理曾的脚本记录所有查询

---

## 分析查询日志

- 推荐pt-query-digest 一款强有力分析MySQL查询日志工具
- 查单条优化，可使用SHOW PROFILE和SHOW STATUS、Performance Schema（待学）p89

---

## 诊断间接性问题

- 指某些无法判断原因的查询结果，即间歇性问题
- 解决方法：有些人通过不断试错来诊断，但不推荐，有很大风险，低效且可能令人沮丧。应选择用解决间接性问题的方法和工具
- 间接性问题先通过判断是单条查询语句初夏难问题还是服务器问题。SHOW GLOBAL STATUS、SHOW PROCESSLIST、查询日志、理解问题等；捕获诊断数据 p93-p8（待学）

---

## 实际案例

- p98-109（待学）

---

## 性能低下的可能原因

- 一个资源被过度使用，雨量已不足以正常使用
- 资源没有被正确配置
- 资源已经损坏或者失灵

